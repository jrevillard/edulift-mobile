name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      platform:
        description: 'Platform to build'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both

env:
  FLUTTER_VERSION: '3.24.3'
  JAVA_VERSION: '17'

jobs:
  # Android build job
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null
    
    strategy:
      matrix:
        flavor: [dev, staging, prod]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: Create Android keystore (debug)
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == null
        run: |
          # Create debug keystore for CI builds
          keytool -genkey -v -keystore android/app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Debug,O=Debug,C=US"
      
      - name: Setup Android keystore (release)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > android/app/release.keystore
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=release.keystore" >> android/key.properties
      
      - name: Build Android APK (debug)
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == null
        run: flutter build apk --debug --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Build Android APK (release)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: flutter build apk --release --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Build Android App Bundle (release only)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: flutter build appbundle --release --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ matrix.flavor }}-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/**/*.aab
      
      - name: Create GitHub Release (for tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/**/*.aab
          tag_name: ${{ github.ref_name }}
          name: EduLift Mobile ${{ github.ref_name }}
          draft: false
          prerelease: contains(github.ref_name, '-')

  # iOS build job
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null
    
    strategy:
      matrix:
        flavor: [dev, staging, prod]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
      
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
      
      - name: Setup iOS certificates and provisioning profiles
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        env:
          IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          # Create temporary keychain
          security create-keychain -p "temppass" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "temppass" build.keychain
          
          # Import certificate
          echo "$IOS_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -P "$IOS_CERTIFICATE_PASSWORD" -k build.keychain -T /usr/bin/codesign
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
      
      - name: Build iOS (debug)
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == null
        run: |
          flutter build ios --debug --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json --no-codesign
      
      - name: Build iOS IPA (release)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: |
          flutter build ipa --release --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Upload iOS App
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ matrix.flavor }}-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            build/ios/ipa/*.ipa
            build/ios/iphoneos/*.app
      
      - name: Create GitHub Release (for tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/ios/ipa/*.ipa
          tag_name: ${{ github.ref_name }}
          name: EduLift Mobile ${{ github.ref_name }}
          draft: false
          prerelease: contains(github.ref_name, '-')
      
      - name: Clean up keychain and provisioning profile
        if: always() && (github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/'))
        run: |
          security delete-keychain build.keychain
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          rm -f certificate.p12

  # Firebase App Distribution (optional)
  firebase-distribution:
    name: Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [build-android]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-dev-debug
          path: ./apk
      
      - name: Setup Firebase CLI
        uses: w9jds/setup-firebase@main
        with:
          tools: appdistribution
          firebase_token: ${{ secrets.FIREBASE_TOKEN }}
      
      - name: Distribute to Firebase
        run: |
          firebase appdistribution:distribute apk/*.apk \
            --app ${{ secrets.FIREBASE_APP_ID_ANDROID }} \
            --groups "internal-testers" \
            --release-notes "Automated build from commit ${{ github.sha }}"
        continue-on-error: true

  # Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    
    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ${{ github.event.inputs.platform || 'both' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type**: ${{ github.event.inputs.build_type || 'debug' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Android Build**: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**iOS Build**: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            echo "**ðŸŽ‰ Release build completed for tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          fi
