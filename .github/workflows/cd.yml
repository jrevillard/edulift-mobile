name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # All version tags trigger builds
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      platform:
        description: 'Platform to build'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both
          - android-fast  # Android dev flavor only

# Cancel in-progress runs when a new commit is pushed
# Note: Tags are not cancelled to ensure release builds complete
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

permissions:
  contents: write  # Required for GitHub Release creation
  deployments: write  # Required for deployment tracking

env:
  FLUTTER_VERSION: '3.35.6'
  JAVA_VERSION: '17'

jobs:
  # Android build job
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 40
    # Run on all non-dispatch events OR on dispatch if platform is not exclusively 'ios'
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.platform != 'ios'

    env:
      # Centralized build type logic - tags always build release, manual dispatch uses input, push defaults to debug
      BUILD_TYPE: ${{ (startsWith(github.ref, 'refs/tags/') && 'release') || github.event.inputs.build_type || 'debug' }}
      # Centralized flavor logic - simplified and maintainable
      FLAVOR: ${{ (github.event.inputs.platform == 'android-fast' && 'development') || (github.ref == 'refs/heads/main' && github.event_name == 'push' && 'development') || (startsWith(github.ref, 'refs/tags/v') && (contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha')) && 'staging') || (startsWith(github.ref, 'refs/tags/v') && 'production') || 'development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter Environment
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
            ${{ runner.os }}-gradle-
            ${{ runner.os }}-

      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: Create Android keystore (debug)
        if: env.BUILD_TYPE == 'debug'
        run: |
          # Create debug keystore for CI builds
          keytool -genkey -v -keystore android/app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Debug,O=Debug,C=US"

      - name: Setup Android keystore (release)
        if: env.BUILD_TYPE == 'release'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
          chmod 600 android/app/release.keystore
          # PKCS12 keystores use the same password for store and key
          printf "storePassword=%s\n" "$KEYSTORE_PASSWORD" > android/key.properties
          printf "keyPassword=%s\n" "$KEYSTORE_PASSWORD" >> android/key.properties
          printf "keyAlias=%s\n" "$KEY_ALIAS" >> android/key.properties
          printf "storeFile=%s\n" "release.keystore" >> android/key.properties
      
      - name: Build Android APK (debug)
        if: env.BUILD_TYPE == 'debug'
        run: flutter build apk --debug --flavor ${{ env.FLAVOR }} --dart-define-from-file=config/${{ env.FLAVOR }}.json

      # APK: Built ONLY for staging (Firebase App Distribution)
      - name: Build Android APK (staging only)
        if: env.BUILD_TYPE == 'release' && env.FLAVOR == 'staging'
        run: |
          echo "ðŸ“± Building APK for Firebase App Distribution (staging)"
          flutter build apk --release --flavor ${{ env.FLAVOR }} --dart-define-from-file=config/${{ env.FLAVOR }}.json

      # AAB: Built ONLY for production (Google Play Store)
      - name: Build Android App Bundle (production only)
        if: env.BUILD_TYPE == 'release' && env.FLAVOR == 'production'
        run: |
          echo "ðŸ“¦ Building AAB for Play Store distribution (production)"
          flutter build appbundle --release --flavor ${{ env.FLAVOR }} --dart-define-from-file=config/${{ env.FLAVOR }}.json

      - name: Upload Android APK (staging)
        if: env.FLAVOR == 'staging'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ env.FLAVOR }}-${{ env.BUILD_TYPE }}
          path: build/app/outputs/flutter-apk/*.apk

      - name: Upload Android AAB (production)
        if: env.FLAVOR == 'production'
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ env.FLAVOR }}-${{ env.BUILD_TYPE }}
          path: build/app/outputs/bundle/**/*.aab

      - name: Clean up Android keystore files
        if: always() && env.BUILD_TYPE == 'release'
        run: |
          rm -f android/key.properties
          rm -f android/app/release.keystore

  # iOS build job - DISABLED (requires Apple Developer Program for distribution)
  # Re-enable when Apple Developer Program account is available
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    timeout-minutes: 40
    if: false  # Disabled - free Apple account cannot distribute to Firebase/TestFlight
    # Original condition: (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null) && (github.event_name == 'push' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))

    env:
      # Centralized build type logic - same as Android job
      BUILD_TYPE: ${{ (startsWith(github.ref, 'refs/tags/') && 'release') || github.event.inputs.build_type || 'debug' }}
      # Centralized flavor logic - platform-agnostic (no android-fast for iOS)
      FLAVOR: ${{ (github.ref == 'refs/heads/main' && github.event_name == 'push' && 'development') || (startsWith(github.ref, 'refs/tags/v') && (contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha')) && 'staging') || (startsWith(github.ref, 'refs/tags/v') && 'production') || 'development' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      # iOS flavor build configurations are already created in project.pbxproj (commit 2405560)
      # - name: Setup iOS flavor build configurations (one-time)
      #   run: |
      #     gem install bundler
      #     bundle install
      #     bundle exec ruby scripts/setup_ios_flavors.rb
      #
      # - name: Commit modified project.pbxproj if changed
      #   run: |
      #     if git diff --quiet ios/Runner.xcodeproj/project.pbxproj; then
      #       echo "No changes to project.pbxproj - configurations already exist"
      #     else
      #       echo "Committing modified project.pbxproj with flavor configurations"
      #       git config user.name "github-actions[bot]"
      #       git config user.email "github-actions[bot]@users.noreply.github.com"
      #       git add ios/Runner.xcodeproj/project.pbxproj
      #       git commit -m "chore: Add iOS flavor build configurations to project.pbxproj [skip ci]"
      #       git push
      #     fi

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: |
          cd ios
          pod install
      
      - name: Setup iOS certificates and provisioning profiles
        if: env.BUILD_TYPE == 'release'
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          # Create temporary keychain
          security create-keychain -p "temppass" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "temppass" build.keychain

          # Import certificate
          echo "$IOS_CERTIFICATE_BASE64" | base64 -d > certificate.p12
          chmod 600 certificate.p12
          security import certificate.p12 -P "$IOS_CERTIFICATE_PASSWORD" -k build.keychain -T /usr/bin/codesign

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          chmod 600 ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
      
      - name: Build iOS (debug)
        if: env.BUILD_TYPE == 'debug'
        run: |
          flutter build ios --debug --flavor ${{ env.FLAVOR }} --dart-define-from-file=config/${{ env.FLAVOR }}.json --no-codesign

      - name: Build iOS IPA (release)
        if: env.BUILD_TYPE == 'release'
        run: |
          flutter build ipa --release --flavor ${{ env.FLAVOR }} --dart-define-from-file=config/${{ env.FLAVOR }}.json

      - name: Upload iOS App
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ env.FLAVOR }}-${{ env.BUILD_TYPE }}
          path: |
            build/ios/ipa/*.ipa
            build/ios/iphoneos/*.app

      - name: Clean up keychain and provisioning profile
        if: always() && env.BUILD_TYPE == 'release'
        run: |
          security delete-keychain build.keychain
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          rm -f certificate.p12

  # GitHub Release - Centralized release creation for tags
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    # TODO: When iOS is enabled, add: && needs.build-ios.result == 'success'
    if: startsWith(github.ref, 'refs/tags/') && needs.build-android.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          tag_name: ${{ github.ref_name }}
          name: EduLift Mobile ${{ github.ref_name }}
          draft: false
          prerelease: contains(github.ref_name, '-')

      # iOS distribution disabled - requires Apple Developer Program
      # - name: Download iOS IPA
      #   if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: ios-app-development-debug
      #     path: ./ipa
      #
      # - name: Distribute iOS to Firebase
      #   if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null
      #   run: |
      #     # iOS development uses edulift-staging project
      #     firebase appdistribution:distribute ipa/*.ipa \
      #       --app 1:390712570284:ios:11ab124204e6c10c054a09 \
      #       --groups "${{ secrets.FIREBASE_GROUPS_STAGING || 'internal-testers' }}" \
      #       --release-notes "Automated iOS development build from commit ${{ github.sha }}"
      #   continue-on-error: true

  # Firebase App Distribution - Staging Release (Android only - iOS disabled)
  # For pre-release tags: v1.0.0-rc.1, v1.0.0-beta.1, v1.0.0-alpha.1
  firebase-distribution-staging:
    name: Firebase App Distribution (Staging Release)
    runs-on: ubuntu-latest
    needs: [build-android]
    if: startsWith(github.ref, 'refs/tags/v') && (contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha'))
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk-staging-release
          path: ./build_artifacts

      - name: Verify APK exists
        id: verify-apk
        run: |
          echo "ðŸ“‚ Listing downloaded artifacts structure:"
          find build_artifacts -type f -name "*.apk" || echo "No APK files found"
          echo ""
          if find build_artifacts -type f -name "*.apk" | grep -q .; then
            APK_PATH=$(find build_artifacts -type f -name "*.apk" | head -n 1)
            echo "apk_found=true" >> $GITHUB_OUTPUT
            echo "âœ… APK found: $APK_PATH"
          else
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "âŒ No APK found in artifacts"
            exit 1
          fi

      - name: Setup Firebase CLI
        uses: w9jds/setup-firebase@main
        with:
          gcp_sa_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}

      - name: Distribute Android APK to Firebase
        run: |
          APK_FILE=$(find build_artifacts -type f -name "*.apk" | head -n 1)
          echo "Distributing STAGING APK: $APK_FILE"
          echo "â„¹ï¸  Note: Using APK instead of AAB (AAB requires Google Play Developer account)"
          firebase appdistribution:distribute "$APK_FILE" \
            --app 1:390712570284:android:343eb2935d6000fe054a09 \
            --groups "${{ secrets.FIREBASE_GROUPS_STAGING || 'internal-testers' }}" \
            --release-notes "Pre-release ${{ github.ref_name }} from commit ${{ github.sha }}"

  # Firebase App Distribution - Production (Android only - iOS disabled)
  firebase-distribution-production:
    name: Firebase App Distribution (Production)
    runs-on: ubuntu-latest
    needs: [build-android]
    if: startsWith(github.ref, 'refs/tags/v') && !(contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha'))
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Android Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk-production-release
          path: ./build_artifacts

      - name: Verify APK exists
        id: verify-apk
        run: |
          echo "ðŸ“‚ Listing downloaded artifacts structure:"
          find build_artifacts -type f -name "*.apk" || echo "No APK files found"
          echo ""
          if find build_artifacts -type f -name "*.apk" | grep -q .; then
            APK_PATH=$(find build_artifacts -type f -name "*.apk" | head -n 1)
            echo "apk_found=true" >> $GITHUB_OUTPUT
            echo "âœ… APK found: $APK_PATH"
          else
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "âŒ No APK found in artifacts"
            exit 1
          fi

      - name: Setup Firebase CLI
        uses: w9jds/setup-firebase@main
        with:
          gcp_sa_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}

      - name: Distribute Android APK to Firebase
        run: |
          APK_FILE=$(find build_artifacts -type f -name "*.apk" | head -n 1)
          echo "Distributing PRODUCTION APK: $APK_FILE"
          echo "â„¹ï¸  Note: Using APK instead of AAB (AAB requires Google Play Developer account)"
          firebase appdistribution:distribute "$APK_FILE" \
            --app 1:928262951410:android:18b5cc75d10217bf779b6b \
            --groups "${{ secrets.FIREBASE_GROUPS_PROD || 'production-testers' }}" \
            --release-notes "Production release ${{ github.ref_name }} from commit ${{ github.sha }}"

  # Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-android, create-github-release, firebase-distribution-staging, firebase-distribution-production]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: Android only (iOS disabled - requires Apple Developer Program)" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type**: ${{ (startsWith(github.ref, 'refs/tags/') && 'release') || github.event.inputs.build_type || 'debug' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Android Build**: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY

          # Only show Firebase distribution results that actually ran (not skipped)
          if [[ "${{ needs.firebase-distribution-staging.result }}" != "skipped" ]]; then
            echo "**Firebase Distribution (Staging Release)**: ${{ needs.firebase-distribution-staging.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.firebase-distribution-production.result }}" != "skipped" ]]; then
            echo "**Firebase Distribution (Production)**: ${{ needs.firebase-distribution-production.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            echo "**ðŸŽ‰ Release build completed for tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          fi

      