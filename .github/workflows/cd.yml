name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      platform:
        description: 'Platform to build'
        required: true
        default: 'both'  # Default to both platforms (dev flavors only)
        type: choice
        options:
          - android
          - ios
          - both
          - android-fast  # Android dev flavor only

permissions:
  contents: read
  deployments: write
  packages: write

env:
  FLUTTER_VERSION: '3.24.3'
  JAVA_VERSION: '17'

jobs:
  # Android build job
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null

    strategy:
      matrix:
        # Smart flavor selection based on trigger and input
        flavor: ${{ github.event.inputs.platform == 'android-fast' && fromJson('["dev"]') || (github.ref == 'refs/heads/main' && github.event_name == 'push' && fromJson('["dev"]')) || fromJson('["dev", "staging", "prod"]') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter Environment
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: Create Android keystore (debug)
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == null
        run: |
          # Create debug keystore for CI builds
          keytool -genkey -v -keystore android/app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Debug,O=Debug,C=US"
      
      - name: Setup Android keystore (release)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
          chmod 600 android/app/release.keystore
          echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "storeFile=release.keystore" >> android/key.properties
      
      - name: Build Android APK (debug)
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == null
        run: flutter build apk --debug --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Build Android APK (release)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: flutter build apk --release --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Build Android App Bundle (release only)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: flutter build appbundle --release --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ matrix.flavor }}-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/**/*.aab
      
      - name: Create GitHub Release (for tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/**/*.aab
          tag_name: ${{ github.ref_name }}
          name: EduLift Mobile ${{ github.ref_name }}
          draft: false
          prerelease: contains(github.ref_name, '-')

  # iOS build job - Build dev flavor on main pushes, all flavors on tags
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    timeout-minutes: 40
    # Build on main pushes (dev only), tags (all), and manual runs
    if: (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null) && (github.event_name == 'push' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))

    strategy:
      matrix:
        # Smart flavor selection: dev on main pushes, all on tags
        flavor: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' && fromJson('["dev"]') || (startsWith(github.ref, 'refs/tags/') && fromJson('["dev", "staging", "prod"]') || fromJson('["dev"]')) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run code generation
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
      
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods
        run: |
          cd ios
          pod install
      
      - name: Setup iOS certificates and provisioning profiles
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
        run: |
          # Create temporary keychain
          security create-keychain -p "temppass" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "temppass" build.keychain

          # Import certificate
          echo "$IOS_CERTIFICATE_BASE64" | base64 -d > certificate.p12
          chmod 600 certificate.p12
          security import certificate.p12 -P "$IOS_CERTIFICATE_PASSWORD" -k build.keychain -T /usr/bin/codesign

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          chmod 600 ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
      
      - name: Build iOS (debug)
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == null
        run: |
          flutter build ios --debug --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json --no-codesign
      
      - name: Build iOS IPA (release)
        if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/')
        run: |
          flutter build ipa --release --flavor ${{ matrix.flavor }} --dart-define-from-file=config/${{ matrix.flavor }}.json
      
      - name: Upload iOS App
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ matrix.flavor }}-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            build/ios/ipa/*.ipa
            build/ios/iphoneos/*.app
      
      - name: Create GitHub Release (for tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/ios/ipa/*.ipa
          tag_name: ${{ github.ref_name }}
          name: EduLift Mobile ${{ github.ref_name }}
          draft: false
          prerelease: contains(github.ref_name, '-')
      
      - name: Clean up keychain and provisioning profile
        if: always() && (github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/'))
        run: |
          security delete-keychain build.keychain
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          rm -f certificate.p12

  # Firebase App Distribution (optional)
  firebase-distribution:
    name: Firebase App Distribution
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk-dev-debug
          path: ./apk

      - name: Setup Firebase CLI
        uses: w9jds/setup-firebase@main
        with:
          tools: appdistribution
          firebase_token: ${{ secrets.FIREBASE_TOKEN }}

      - name: Distribute Android to Firebase
        run: |
          firebase appdistribution:distribute apk/*.apk \
            --app 1:390712570284:android:343eb2935d6000fe054a09 \
            --groups "${{ secrets.FIREBASE_GROUPS_STAGING || 'internal-testers' }}" \
            --release-notes "Automated Android development build from commit ${{ github.sha }}"
        continue-on-error: true

      - name: Download iOS IPA
        if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null
        uses: actions/download-artifact@v4
        with:
          name: ios-app-dev-debug
          path: ./ipa

      - name: Distribute iOS to Firebase
        if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || github.event.inputs.platform == null
        run: |
          # iOS development uses edulift-staging project
          firebase appdistribution:distribute ipa/*.ipa \
            --app 1:390712570284:ios:11ab124204e6c10c054a09 \
            --groups "${{ secrets.FIREBASE_GROUPS_STAGING || 'internal-testers' }}" \
            --release-notes "Automated iOS development build from commit ${{ github.sha }}"
        continue-on-error: true

  # Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, firebase-distribution]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ${{ github.event.inputs.platform || 'both' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type**: ${{ github.event.inputs.build_type || 'debug' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Android Build**: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**iOS Build**: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Firebase Distribution**: ${{ needs.firebase-distribution.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            echo "**ðŸŽ‰ Release build completed for tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          fi

      