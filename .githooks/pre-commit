#!/bin/bash
# EduLift Mobile - Pre-commit Hook
# Ensures code quality before committing

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# Step 1: Format Dart code
echo ""
echo "ðŸ“ Step 1/2: Formatting Dart code..."
if dart format . > /dev/null 2>&1; then
    print_success "Code formatted successfully"

    # Check if formatting made changes
    if ! git diff --exit-code > /dev/null 2>&1; then
        print_warning "Code was reformatted. Changes have been staged automatically."
        git add -u
    fi
else
    print_error "dart format failed"
    exit 1
fi

# Step 2: Run flutter analyze
echo ""
echo "ðŸ” Step 2/2: Running flutter analyze..."
ANALYZE_OUTPUT=$(flutter analyze 2>&1)
ANALYZE_EXIT_CODE=$?

if [ $ANALYZE_EXIT_CODE -eq 0 ]; then
    # Check if there are any issues
    if echo "$ANALYZE_OUTPUT" | grep -q "No issues found"; then
        print_success "No issues found in code analysis"
    else
        print_warning "Analysis completed with warnings:"
        echo "$ANALYZE_OUTPUT"
    fi
else
    print_error "flutter analyze found issues:"
    echo ""
    echo "$ANALYZE_OUTPUT"
    echo ""
    print_error "Please fix the issues above before committing."
    exit 1
fi

# All checks passed
echo ""
echo -e "${GREEN}âœ¨ All pre-commit checks passed!${NC}"
echo ""

exit 0
