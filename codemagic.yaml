# Codemagic CI/CD Configuration for EduLift Mobile
# iOS builds only - Android handled by GitHub Actions
# Builds are coordinated by unified release workflow

definitions:
  scripts:
    - &get-packages
      name: Get Flutter packages
      script: |
        flutter pub get

    - &code-generation
      name: Run code generation
      script: |
        flutter pub run build_runner build --delete-conflicting-outputs

    - &install-tools
      name: Install dependencies and tools
      script: |
        cd ios && pod install

    - &update-version
      name: Update version from tag
      script: |
        # Update pubspec.yaml version from environment (set by GitHub Actions trigger)
        if [[ -n "$GITHUB_TAG" ]]; then
          echo "ðŸ·ï¸ Updating pubspec.yaml from tag: $GITHUB_TAG"

          # Remove 'v' prefix
          TAG_NAME="$GITHUB_TAG"
          VERSION="${TAG_NAME#v}"

          # Extract base version
          BASE_VERSION=$(echo "$VERSION" | sed -E 's/(-alpha|-beta|-rc).*//')

          # Use timestamp for iOS build number (ensures uniqueness)
          IOS_BUILD_NUMBER=$(date +%s)

          echo "ðŸ“Œ Tag: $TAG_NAME"
          echo "ðŸ“Œ Version: $BASE_VERSION"
          echo "ðŸ“Œ iOS build number: $IOS_BUILD_NUMBER"

          # Update pubspec.yaml
          sed -i '' "s/^version: .*/version: $BASE_VERSION+$IOS_BUILD_NUMBER/" pubspec.yaml

          echo "âœ… Updated pubspec.yaml:"
          grep "^version:" pubspec.yaml
        else
          echo "â„¹ï¸ No GITHUB_TAG provided, keeping existing version"
        fi

    - &configure-ios
      name: Configure iOS Deep Links
      script: |
        # Configure iOS deep links from config/DEEP_LINK_BASE_URL
        echo "ðŸ”§ Configuring iOS deep links for $FLAVOR environment"
        ./scripts/configure_ios.sh $FLAVOR

        # Verify configuration
        echo "ðŸ“± iOS Configuration Summary:"
        echo "âœ… Info.plist updated with URL schemes"
        if [[ -f "ios/Runner/Runner.entitlements" ]]; then
          echo "âœ… Entitlements file created/updated"
          if grep -q "com.apple.developer.associated-domains" ios/Runner/Runner.entitlements; then
            echo "ðŸŒ Universal Links configured"
          else
            echo "ðŸ“± Custom URL scheme only (no Universal Links)"
          fi
        else
          echo "ðŸ“± Custom URL scheme only (no entitlements needed)"
        fi

    - &build-ios
      name: Build iOS IPA
      script: |
        echo "ðŸš€ Building iOS IPA with xcodebuild approach"

        # Verify Flutter environment
        echo "ðŸ“‹ Flutter version: $(flutter --version)"
        echo "ðŸ“‹ Working directory: $(pwd)"

        # Clean previous builds
        echo "ðŸ§¹ Cleaning previous builds..."
        rm -rf ios/build/

        # Run the build script
        echo "ðŸ”§ Running iOS build script..."
        if ./scripts/build_unsigned_ios.sh $FLAVOR; then
          echo "âœ… Build completed successfully"
        else
          echo "âŒ Build failed"
          exit 1
        fi

        # Find IPA from build location
        echo "ðŸ” Looking for IPA: ios/build/ipa/edulift-$FLAVOR.ipa"
        echo "ðŸ” FLAVOR value: $FLAVOR"
        echo "ðŸ” Available IPA files:"
        find ios/build -name "*.ipa" 2>/dev/null || echo "No IPA files found"

        IPA_PATH="ios/build/ipa/edulift-$FLAVOR.ipa"

        if [[ -f "$IPA_PATH" ]]; then
          echo "âœ… IPA found at build location: $IPA_PATH"
          echo "âœ… IPA ready!"
          echo "ðŸ“Š IPA details:"
          ls -lh "$IPA_PATH"
          file "$IPA_PATH"
          echo "ðŸ“¦ Size: $(du -h "$IPA_PATH" | cut -f1)"
        else
          echo "âŒ IPA not found at expected location"
          echo "ðŸ” Available files:"
          find ios/build -name "*.ipa" 2>/dev/null || echo "No IPA files found"
          exit 1
        fi

    - &build-complete
      name: Build Complete Notification
      script: |
        echo "âœ… iOS $FLAVOR build completed successfully!"
        echo "ðŸ“¦ IPA ready for download in unified release workflow"
        echo "ðŸ”— Build artifacts will be collected by GitHub Actions"

workflows:
  # iOS Staging Build - Triggered by API only
  ios-staging:
    name: iOS Staging
    instance_type: mac_mini_m2
    max_build_duration: 60

    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
        - ios/Pods
        - ios/Pods/.lock
        - .dart_tool

    environment:
      groups:
        - firebase # FIREBASE_SERVICE_ACCOUNT_STAGING
      # Versions from .github/ci-versions.env - Use Codemagic UI variables to override
      flutter: 3.38.2
      xcode: 16.4
      cocoapods: default
      vars:
        FLAVOR: staging
        BUNDLE_ID: "com.edulift.app.staging"
        GITHUB_TAG: "${{ github.ref_name }}"  # This will be set by GitHub Actions

    scripts:
      - *get-packages
      - *code-generation
      - *update-version
      - *install-tools
      - *configure-ios
      - *build-ios
      - *build-complete

    artifacts:
      - ios/build/ipa/*.ipa

    publishing:
      firebase:
        firebase_service_account: $FIREBASE_SERVICE_ACCOUNT_STAGING
        ios:
          app_id: 1:390712570284:ios:11ab124204e6c10c054a09
          groups:
            - staging-team

      email:
        recipients:
          - jerome.revillard@wanadoo.fr
        notify:
          success: true
          failure: true

  # iOS Production Build - Triggered by API only
  ios-production:
    name: iOS Production
    instance_type: mac_mini_m2
    max_build_duration: 60

    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
        - ios/Pods
        - ios/Pods/.lock
        - .dart_tool

    environment:
      groups:
        - firebase # FIREBASE_SERVICE_ACCOUNT_PROD
      # Versions from .github/ci-versions.env - Use Codemagic UI variables to override
      flutter: 3.38.2
      xcode: 16.4
      cocoapods: default
      vars:
        FLAVOR: production
        BUNDLE_ID: "com.edulift.app"
        GITHUB_TAG: "${{ github.ref_name }}"  # This will be set by GitHub Actions

    scripts:
      - *get-packages
      - *code-generation
      - *update-version
      - *install-tools
      - *configure-ios
      - *build-ios
      - *build-complete

    artifacts:
      - ios/build/ipa/*.ipa

    publishing:
      firebase:
        firebase_service_account: $FIREBASE_SERVICE_ACCOUNT_PROD
        ios:
          app_id: 1:928262951410:ios:139da35e9a165907779b6b
          groups:
            - production-team

      email:
        recipients:
          - jerome.revillard@wanadoo.fr
        notify:
          success: true
          failure: true