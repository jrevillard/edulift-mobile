# Codemagic CI/CD Configuration for EduLift Mobile
# iOS builds only - Android handled by GitHub Actions
# Builds are coordinated by unified release workflow

definitions:
  scripts:
    - &get-packages
      name: Get Flutter packages
      script: |
        flutter pub get

    - &code-generation
      name: Run code generation
      script: |
        flutter pub run build_runner build --delete-conflicting-outputs

    - &install-tools
      name: Install dependencies and tools
      script: |
        cd ios && pod install

  
    - &configure-ios
      name: Configure iOS Deep Links
      script: |
        # Configure iOS deep links from config/DEEP_LINK_BASE_URL
        echo "ðŸ”§ Configuring iOS deep links for $FLAVOR environment"
        ./scripts/configure_ios.sh $FLAVOR

        # Verify configuration
        echo "ðŸ“± iOS Configuration Summary:"
        echo "âœ… Info.plist updated with URL schemes"
        if [[ -f "ios/Runner/Runner.entitlements" ]]; then
          echo "âœ… Entitlements file created/updated"
          if grep -q "com.apple.developer.associated-domains" ios/Runner/Runner.entitlements; then
            echo "ðŸŒ Universal Links configured"
          else
            echo "ðŸ“± Custom URL scheme only (no Universal Links)"
          fi
        else
          echo "ðŸ“± Custom URL scheme only (no entitlements needed)"
        fi

    - &build-ios
      name: Build iOS IPA
      script: |
        echo "ðŸš€ Building iOS IPA with xcodebuild approach"

        # Verify Flutter environment
        echo "ðŸ“‹ Flutter version: $(flutter --version)"
        echo "ðŸ“‹ Working directory: $(pwd)"

        # Clean previous builds
        echo "ðŸ§¹ Cleaning previous builds..."
        rm -rf ios/build/

        # Run the build script
        echo "ðŸ”§ Running iOS build script..."
        if ./scripts/build_unsigned_ios.sh $FLAVOR; then
          echo "âœ… Build completed successfully"
        else
          echo "âŒ Build failed"
          exit 1
        fi

        # Find IPA from build location
        echo "ðŸ” Looking for IPA: ios/build/ipa/edulift-$FLAVOR.ipa"
        echo "ðŸ” FLAVOR value: $FLAVOR"
        echo "ðŸ” Available IPA files:"
        find ios/build -name "*.ipa" 2>/dev/null || echo "No IPA files found"

        IPA_PATH="ios/build/ipa/edulift-$FLAVOR.ipa"

        if [[ -f "$IPA_PATH" ]]; then
          echo "âœ… IPA found at build location: $IPA_PATH"
          echo "âœ… IPA ready!"
          echo "ðŸ“Š IPA details:"
          ls -lh "$IPA_PATH"
          file "$IPA_PATH"
          echo "ðŸ“¦ Size: $(du -h "$IPA_PATH" | cut -f1)"
        else
          echo "âŒ IPA not found at expected location"
          echo "ðŸ” Available files:"
          find ios/build -name "*.ipa" 2>/dev/null || echo "No IPA files found"
          exit 1
        fi

    - &build-complete
      name: Build Complete Notification
      script: |
        echo "âœ… iOS $FLAVOR build completed successfully!"
        echo "ðŸ“¦ IPA ready for download in unified release workflow"
        echo "ðŸ”— Build artifacts will be collected by GitHub Actions"

workflows:
  # iOS Staging Build - Triggered by API only
  ios-staging:
    name: iOS Staging
    instance_type: mac_mini_m2
    max_build_duration: 60

    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
        - $HOME/.cocoapods/cache
        - ios/Pods
        - ios/Podfile.lock
        - .dart_tool
        - build/.dart_tool
        - ios/.symlinks
        - ios/Flutter/flutter_assets
        - ios/Flutter/Flutter.framework

    environment:
      groups:
        - firebase # FIREBASE_SERVICE_ACCOUNT_STAGING
      # Versions from .github/ci-versions.env - Use Codemagic UI variables to override
      flutter: 3.38.2
      xcode: 16.4
      cocoapods: default
      vars:
        FLAVOR: staging
        BUNDLE_ID: "com.edulift.app.staging"
        GITHUB_TAG: "${{ github.ref_name }}"  # This will be set by GitHub Actions

    scripts:
      - *get-packages
      - *code-generation
      - *install-tools
      - *configure-ios
      - *build-ios
      - *build-complete

    artifacts:
      - ios/build/ipa/*.ipa

  # iOS Production Build - Triggered by API only
  ios-production:
    name: iOS Production
    instance_type: mac_mini_m2
    max_build_duration: 60

    cache:
      cache_paths:
        - $FLUTTER_ROOT/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
        - $HOME/.cocoapods/cache
        - ios/Pods
        - ios/Podfile.lock
        - .dart_tool
        - build/.dart_tool
        - ios/.symlinks
        - ios/Flutter/flutter_assets
        - ios/Flutter/Flutter.framework

    environment:
      groups:
        - firebase # FIREBASE_SERVICE_ACCOUNT_PROD
      # Versions from .github/ci-versions.env - Use Codemagic UI variables to override
      flutter: 3.38.2
      xcode: 16.4
      cocoapods: default
      vars:
        FLAVOR: production
        BUNDLE_ID: "com.edulift.app"
        GITHUB_TAG: "${{ github.ref_name }}"  # This will be set by GitHub Actions

    scripts:
      - *get-packages
      - *code-generation
      - *install-tools
      - *configure-ios
      - *build-ios
      - *build-complete

    artifacts:
      - ios/build/ipa/*.ipa